<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Upload</title>
</head>
<body>
    <form id="upload" onsubmit="handleSubmit(event)">
        <label for="name">Name</label>
        <input type="text" name="name" id="name" onblur="handleTextInput(event)" autocomplete="name">
        <label for="email">Email</label>
        <input type="email" id="email" onblur="handleTextInput(event)" autocomplete="email">
        <label for="size">Size</label>
        <input type="text" id="size" onblur="handleTextInput(event)">
        <label for="quantity">Quantity</label>
        <input type="number" id="quantity" onblur="handleTextInput(event)">
        <label for="message">Message</label>
        <textarea name="message" id="message" onblur="handleTextInput(event)"></textarea>
        <label for="image1">Image #1 to upload</label>
        <input type="file" id="image1" class="image-input" accept="image/*" onchange="handleImageInput(event)">
        <label for="image2">Image #2 to upload</label>
        <input type="file" id="image2" accept="image/*" class="image-input" onchange="handleImageInput(event)">
        <button type="submit">Submit</button>
    </form>
<script>
    sessionStorage.clear();
    let fileName = "";
    let imageCount = 0;
    const tinyFormUrl = "http://localhost:3000/";
    const imageKitUrl = "https://upload.imagekit.io/api/v1/files/upload";
    const jsonHeader = {'Content-Type': 'application/json'}


    const fetchManager = async (url, method, body, headers) => {
        const response = await fetch(url, {method, body, headers: {...headers}})

        if (!response.ok) {
            throw new Error ("Unable to complet your API Request");
        } else {
            const data = await response.json()

            return data;
        }
    }

    async function uploadImage (image, authData) {
        const docId = sessionStorage.getItem("docId")
        const putURL = `${tinyFormUrl}quote/${docId}`


        const formData = new FormData();
        formData.append('file', image);
        formData.append('fileName', fileName);
        formData.append('signature', authData.signature);
        formData.append('expire', authData.expire);
        formData.append('token', authData.token);
        formData.append('publicKey', 'public_2AP5qW3G4Go1j4IJj36sCR+Zr9k=')

        fetchManager(imageKitUrl, "POST", formData).then((data) => {

            const serializedData = {url: data.url, nam: data.name}
            const imageBody = JSON.stringify({[`image${imageCount}`]: serializedData});

            fetchManager(putURL, "PUT", imageBody, jsonHeader).then(() => {
                console.log("Success!")
            }).catch((err) => {
                console.error(err);
            })
        }).catch(err => console.error(err));

    };
    
    const handleTextInput = async (event) => {
        let hasId = sessionStorage.getItem("docId")
        console.log(hasId)
        const postBody = {[event.target.id]: event.target.value};

        if (!hasId && event.target.value) {


            const postRes = await fetch(`${tinyFormUrl}quote`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postBody),
            });
            
            if (!postRes.ok) {
                throw new Error("POST Error:", postRes.status);
            }
            
            const data = await postRes.json();
            sessionStorage.setItem("docId", data.docId)
        } else if (event.target.value) {
        const putRes = await fetch (`${tinyFormUrl}quote/${hasId}`, {
            method: "PUT",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postBody),
        })

        if (!putRes.ok) {
            throw new Error("PUT Error:", putRes.status);
        }
        }
    };

    async function abandonQuote () {

    }
    // if a customer focuses on the photo first, call the auth end point
    async function photoAuth () {
        const getAuth = await fetch (`${tinyFormUrl}upload`)

        if (!getAuth.ok) {
            throw new Error("unable to upload image")
        }  else {
            const data = getAuth.json();

            return data;
            
        }
    }
    

    const logFile = async (event) => {
        let str = event.target.result;

        photoAuth().then((authData) => {

            uploadImage(str, authData).then((response) => {
                
            }).catch(error => console.log(error))
        }). catch(error => console.log(error))
    }

    const handleImageInput = async (event) => {
        const docId = sessionStorage.getItem("docId")

        if (event.target.value && docId) {   
            fileName = event.target.files[0].name

            let reader = new FileReader()

            imageCount ++;

            reader.onload = logFile;

            reader.readAsDataURL(event.target.files[0])
        };

    };

    const handleSubmit = async (event) => {
        let docId = sessionStorage.getItem("docId")
        const putRes = await fetch (`${url}quote/${docId}`, {
            method: "PUT",
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({submitted: true}),
        })

        if (!putRes.ok) {
            throw new Error("PUT Error:", putRes.status);
        }

    }

</script>
</body>
</html>