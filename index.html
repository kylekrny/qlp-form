<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Upload</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>
<body>
    <div id="form-container">
        <div id="success-message" class="message">
            <h2>Thank you!</h2>
            <h6>We have received your request.</h6>
            <p>
                Next, you will recieve an email from one of our team members with a quote and digital proof.
            </p>

            <p>If you have any questions you can call us at <a href="tel:+18009520305">1-800-952-0305.</a></p>

            <button onclick="showForm(event)">Submit again</button>
        </div>
        <div id="loading" class="message">
            <img src="https://ik.imagekit.io/kylekrny/Spinner@1x-1.0s-200px-200px.gif?updatedAt=1723554463306" alt="" srcset="" width="128px">
        </div>
        <div id="error-message" class="message">
            <h2>Whoops!</h2>
            <h6>There was an internal error.</h6>
            <p>
                Please reach out to us to discuss your quote.
            </p>
            <p> Email: <a href="mailto:">info@qualitylapelpins.com</a></p>

            <p>Phone: <a href="tel:+18009520305">1-800-952-0305.</a></p>

            <button onclick="showForm(event)">Submit again</button>
        </div>
        <form id="quote-form" onsubmit="handleSubmit(event)" onmouseleave="handleFormExit(event)" onmouseover="handleFormEnter(event)">
            <label for="name">Name</label>
            <input type="text" name="name" placeholder="John Lapel" id="name" onblur="handleTextInput(event)" autocomplete="name">
            <label for="email">Email <span class="helper">You will NOT be added to a mailing list.</span></label>
            <input type="email" name="email" placeholder="johnlapel@pins.com" id="email" onblur="handleTextInput(event)" autocomplete="email">
            <label for="size">Size <span class="helper">(in inches)</span></label>
            <input type="text" name="size" id="size" placeholder="2 inches" onblur="handleTextInput(event)">
            <label for="quantity">Quantity</label>
            <input type="number" name="quantity" id="quantity" placeholder="ex. 100" onblur="handleTextInput(event)" min="1">
            <label for="location">Shipping Location</label>
            <select name="shippingLocation" id="shippingLocation" plac>
                    <option value="" disabled selected>Select your location</option>
                    <option value="US - Alabama">US - Alabama</option>
                    <option value="US - Alaska">US - Alaska</option>
                    <option value="US - Arizona">US - Arizona</option>
                    <option value="US - Arkansas">US - Arkansas</option>
                    <option value="US - California">US - California</option>
                    <option value="US - Colorado">US - Colorado</option>
                    <option value="US - Connecticut">US - Connecticut</option>
                    <option value="US - Delaware">US - Delaware</option>
                    <option value="US - District of Columbia">US - District of Columbia</option>
                    <option value="US - Florida">US - Florida</option>
                    <option value="US - Georgia">US - Georgia</option>
                    <option value="US - Hawaii">US - Hawaii</option>
                    <option value="US - Idaho">US - Idaho</option>
                    <option value="US - Illinois">US - Illinois</option>
                    <option value="US - Indiana">US - Indiana</option>
                    <option value="US - Iowa">US - Iowa</option>
                    <option value="US - Kansas">US - Kansas</option>
                    <option value="US - Kentucky">US - Kentucky</option>
                    <option value="US - Louisiana">US - Louisiana</option>
                    <option value="US - Maine">US - Maine</option>
                    <option value="US - Maryland">US - Maryland</option>
                    <option value="US - Massachusetts">US - Massachusetts</option>
                    <option value="US - Michigan">US - Michigan</option>
                    <option value="US - Minnesota">US - Minnesota</option>
                    <option value="US - Mississippi">US - Mississippi</option>
                    <option value="US - Missouri">US - Missouri</option>
                    <option value="US - Montana">US - Montana</option>
                    <option value="US - Nebraska">US - Nebraska</option>
                    <option value="US - Nevada">US - Nevada</option>
                    <option value="US - New Hampshire">US - New Hampshire</option>
                    <option value="US - New Jersey">US - New Jersey</option>
                    <option value="US - New Mexico">US - New Mexico</option>
                    <option value="US - New York">US - New York</option>
                    <option value="US - North Carolina">US - North Carolina</option>
                    <option value="US - North Dakota">US - North Dakota</option>
                    <option value="US - Ohio">US - Ohio</option>
                    <option value="US - Oklahoma">US - Oklahoma</option>
                    <option value="US - Oregon">US - Oregon</option>
                    <option value="US - Pennsylvania">US - Pennsylvania</option>
                    <option value="US - Rhode Island">US - Rhode Island</option>
                    <option value="US - South Carolina">US - South Carolina</option>
                    <option value="US - South Dakota">US - South Dakota</option>
                    <option value="US - Tennessee">US - Tennessee</option>
                    <option value="US - Texas">US - Texas</option>
                    <option value="US - Utah">US - Utah</option>
                    <option value="US - Vermont">US - Vermont</option>
                    <option value="US - Virginia">US - Virginia</option>
                    <option value="US - Washington">US - Washington</option>
                    <option value="US - West Virginia">US - West Virginia</option>
                    <option value="US - Wisconsin">US - Wisconsin</option>
                    <option value="US - Wyoming">US - Wyoming</option>
                    <option value="APO - FPO">APO - FPO</option>
                    <option value="Canada - Alberta">Canada - Alberta</option>
                    <option value="Canada - British Columbia">Canada - British Columbia</option>
                    <option value="Canada - Manitoba">Canada - Manitoba</option>
                    <option value="Canada - New Brunswick">Canada - New Brunswick</option>
                    <option value="Canada - Newfoundland">Canada - Newfoundland</option>
                    <option value="Canada - Nova Scotia">Canada - Nova Scotia</option>
                    <option value="Canada - Ontario">Canada - Ontario</option>
                    <option value="Canada - Prince Edward Island">Canada - Prince Edward Island</option>
                    <option value="Canada - Quebec">Canada - Quebec</option>
                    <option value="Canada - Saskatchewan">Canada - Saskatchewan</option>
                    <option value="Argentina">Argentina</option>
                    <option value="Australia">Australia</option>
                    <option value="Austria">Austria</option>
                    <option value="Belarus">Belarus</option>
                    <option value="Belgium">Belgium</option>
                    <option value="Bolivia">Bolivia</option>
                    <option value="Brazil">Brazil</option>
                    <option value="Brunei Darussalam">Brunei Darussalam</option>
                    <option value="Bulgaria">Bulgaria</option>
                    <option value="Chile">Chile</option>
                    <option value="China">China</option>
                    <option value="Colombia">Colombia</option>
                    <option value="Costa Rica">Costa Rica</option>
                    <option value="Croatia">Croatia</option>
                    <option value="Czech Republic">Czech Republic</option>
                    <option value="Denmark">Denmark</option>
                    <option value="England">England</option>
                    <option value="Finland">Finland</option>
                    <option value="France">France</option>
                    <option value="Germany">Germany</option>
                    <option value="Greece">Greece</option>
                    <option value="Guatemala">Guatemala</option>
                    <option value="India">India</option>
                    <option value="Indonesia">Indonesia</option>
                    <option value="Ireland">Ireland</option>
                    <option value="Israel">Israel</option>
                    <option value="Italy">Italy</option>
                    <option value="Japan">Japan</option>
                    <option value="Latvia">Latvia</option>
                    <option value="Lithuania">Lithuania</option>
                    <option value="Luxembourg">Luxembourg</option>
                    <option value="Macedonia">Macedonia</option>
                    <option value="Malaysia">Malaysia</option>
                    <option value="Mexico">Mexico</option>
                    <option value="Myanmar">Myanmar</option>
                    <option value="Nepal">Nepal</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="New Zealand">New Zealand</option>
                    <option value="Norway">Norway</option>
                    <option value="Panama">Panama</option>
                    <option value="Peru">Peru</option>
                    <option value="Philippines">Philippines</option>
                    <option value="Poland">Poland</option>
                    <option value="Portugal">Portugal</option>
                    <option value="Puerto Rico">Puerto Rico</option>
                    <option value="Russia">Russia</option>
                    <option value="Scotland">Scotland</option>
                    <option value="Singapore">Singapore</option>
                    <option value="Slovenia">Slovenia</option>
                    <option value="South Africa">South Africa</option>
                    <option value="South Korea">South Korea</option>
                    <option value="Spain">Spain</option>
                    <option value="Sweden">Sweden</option>
                    <option value="Switzerland">Switzerland</option>
                    <option value="Taiwan">Taiwan</option>
                    <option value="Thailand">Thailand</option>
                    <option value="Uruguay">Uruguay</option>
                    <option value="Venezuela">Venezuela</option>
                    <option value="Wales">Wales</option>
                    <option value="Yugoslavia">Yugoslavia</option>
                    <option value="Other">Other</option>
            </select>
            <label for="message">Message</label>
            <textarea name="message" id="message" placeholder="Your message.." onblur="handleTextInput(event)"></textarea>
            <label for="image1">Image #1 to upload</label>
            <input type="file" name="image1" id="image1" class="image-input" accept="image/*" onchange="handleImageInput(event)">
            <label for="image2">Image #2 to upload</label>
            <input type="file" name=image2" id="image2" accept="image/*" class="image-input" onchange="handleImageInput(event)">
            <button type="submit">Submit</button>
        </form>
    </div>
<script>
    sessionStorage.clear();
    let fileName = "";
    let imageCount = 0;
    let formOccupied = false;
    let timer = 0;
    let timeout;
    let timerOn = false;
    const productName = "Soft Enamel Lapel Pins"
    const timerLimit = 60;
    const quoteForm = document.getElementById("quote-form");
    const successMessage = document.getElementById("success-message");
    const errorMessage = document.getElementById("error-message");
    const loading = document.getElementById("loading")
    // const tinyFormUrl = "https://qlp-server-if5ncioobq-uc.a.run.app/";
    const tinyFormUrl = "http://localhost:3000/";
    const imageKitUrl = "https://upload.imagekit.io/api/v1/files/upload";
    const jsonHeader = {'Content-Type': 'application/json'}
    const POST = "POST";
    const PUT = "PUT";
    const GET = "GET";


    const fetchManager = async (url, method, body, headers) => {
        const response = await fetch(url, {method, body, headers: {...headers}})
        if (!response.ok) {
            throw new Error ("Unable to complete your API Request");
        } else {
            const responseClone = response.clone();
            const data = await response.json();

            return data;
        }
    }

    async function uploadImage (image, authData) {
        const docId = sessionStorage.getItem("docId")
        const putURL = `${tinyFormUrl}quote/${docId}`


        const formData = new FormData();
        formData.append('file', image);
        formData.append('fileName', fileName);
        formData.append('signature', authData.signature);
        formData.append('expire', authData.expire);
        formData.append('token', authData.token);
        formData.append('publicKey', 'public_2AP5qW3G4Go1j4IJj36sCR+Zr9k=')

        // uploads image to image kit
        fetchManager(imageKitUrl, POST, formData).then((data) => {
            const serializedData = {url: data.url, name: data.name}
            const imageBody = JSON.stringify({[`image${imageCount}`]: serializedData});
            // sends data we get back from image kit to server
            fetchManager(putURL, PUT, imageBody, jsonHeader).then(() => {
            }).catch((err) => {
                console.error("Unable to upload image.");
            });
        }).catch(err => console.error(err));

    };
    
    const handleTextInput = async (event) => {
        if (event.target.value) {   
            let docId = sessionStorage.getItem("docId")
            const body = JSON.stringify({[event.target.id]: event.target.value, product: productName});
            const url = `${tinyFormUrl}quote${docId ? `/${docId}` : ''}`;
            const method = docId ? PUT : POST;

            fetchManager(url, method, body, jsonHeader).then((data) => {
                !docId && sessionStorage.setItem("docId", data.docId)
            }).catch((err) => {
                console.error(err);
            });

        };
    };

    const manageTimeout = () => {
        timer ++
        timeout = setTimeout(manageTimeout, 1000);

        if (timer >= timerLimit) {
             const docId = sessionStorage.getItem("docId");
            const exitUrl = `${tinyFormUrl}exit/${docId}`;
            const body = JSON.stringify({abandoned: true});

            fetchManager(exitUrl, GET).then(() => {
                clearTimeout(timeout);
                sessionStorage.clear();
            }).catch((err) => {
                clearTimeout(timeout);
                sessionStorage.clear();
            });

        }
    }

    const handleFormExit = (event) => {
        let docId = sessionStorage.getItem("docId");

        if (!timerOn && docId) {
            timerOn = true;
            manageTimeout();
        }

    }

    const handleFormEnter = () => {
        clearTimeout(timeout);
        timerOn = false;
        timer = 0;
    };

    async function photoAuth () {
        const url = `${tinyFormUrl}upload`;
        return fetchManager(url, GET)
    };
    

    const logFile = async (event) => {
        let base64Image = event.target.result;

        photoAuth().then((authData) => {
            uploadImage(base64Image, authData).catch(error => console.log(error));
        }).catch(error => console.log(error));
    }

    const handleImageInput = async (event) => {
        const docId = sessionStorage.getItem("docId")

        if (event.target.value && docId) {   
            fileName = event.target.files[0].name
            
            let reader = new FileReader();
            imageCount ++;
            reader.onload = logFile;
            reader.readAsDataURL(event.target.files[0])
        };

    };

    const displayMessage = (message, otherMessage) => {
        quoteForm.style.display =  "none";
        if (otherMessage) {
            otherMessage.style.display = "none";
        }
        message.style.display = "flex";
    }

    const showForm = () => {
        quoteForm.reset();
        successMessage.style.display = "none";
        errorMessage.style.display = "none";
        quoteForm.style.display =  "flex";
    }

    const handleSubmit = async (event) => {
        event.preventDefault();


        const docId = sessionStorage.getItem("docId");
        const url = `${tinyFormUrl}quote/${docId}`;
        const body = JSON.stringify({submitted: true});


        if (docId) {   
            displayMessage(loading);
            fetchManager(url, PUT, body, jsonHeader).then(() => {
                sessionStorage.clear();
                displayMessage(successMessage, loading)

            }).catch(() => {
                sessionStorage.clear();
                displayMessage(errorMessage, loading)
            });
        }
    };

</script>
<style>

    #form-container {
        width: 400px;
        font-family: Arial, Helvetica, sans-serif;
    }

   #quote-form {
    display: flex;
    flex-direction: column;
   }

   #quote-form label {
    font-family: Arial, Helvetica, sans-serif;
    margin-bottom: 5px;
    margin-top: 10px;
   }


   #quote-form input, textarea, select {
    border-radius: 5px;
    border: 1px solid #c9cfd6;
    height: 30px;
   }

   #quote-form button {
    padding-top: 15px;
    padding-bottom: 15px;
    background-color: #0075c9;
    color: white;
    font-size: 20px;
    border-radius: 10px;
    border: none;
    margin-top: 15px;
    transition: background-color 0.1s ease-in-out;
   }

   #quote-form button:hover {
    background-color: #006ab7;
    /* box-shadow: 0 1px 1px rgba(0,0,0,0.12), 
                0 2px 2px rgba(0,0,0,0.12), 
                0 4px 4px rgba(0,0,0,0.12), 
                0 8px 8px rgba(0,0,0,0.12),
                0 16px 16px rgba(0,0,0,0.12); */
   }

   #quote-form button:active {
    background-color: transparent;
    color: #0075c9;
   }

   #quote-form .helper {
    font-size: 11px;
    font-weight: 300;
    color: black;
   }

    #quote-form input::file-selector-button, .message button {
        background-color: transparent;
        border: 1px solid #0075c9;
        border-radius: 5px;
        color: #0075c9;
        padding-left: 10px;
        padding-right: 10px;
        padding-top: 5px;
        padding-bottom: 5px;

    }

    #quote-form .image-input {
        border: none;
        height: 40px;
    }

    #quote-form #message {
        height: 60px;
    }

    #quote-form input::file-selector-button:hover, #quote-form input::file-selector-button:active, .message button:hover {
        background-color: #0075c9;
        color: white;
    }

    i {
        color: green;
        height: 50px;
        width: auto;
    }

    .message {
        font-family: Arial, Helvetica, sans-serif;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        min-height: 400px;
    }

    .message h2 {
        font-weight: 300;
        margin-bottom: 0px;
        padding-bottom: 0px;
        font-size: 32px;
        color: #0075c9;
    }

    .message h6 {
        margin-top: 10px;
        font-size: 12px;
    }

    .message p {
        width: 95%;
        text-align: center;
        margin-top: 0px;
    }

    .message a {
        color: #0075c9;
        text-decoration: none;
    }

    #error-message h2 {
        color: red;
    }
</style>
</body>
</html>